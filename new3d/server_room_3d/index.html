<!DOCTYPE html><html><head><title>Viewer</title><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@800&display=swap" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css"><link rel="stylesheet" href="style_topbar.css"><link rel="stylesheet" href="style_panel.css"><link rel="stylesheet" href="style_dashboard.css"><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script><script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script><script src="obj_hover.js"></script><script src="info_panel.js"></script><script src="top_bar.js"></script><script src="monitoring.js"></script><script src="service_abnormal_top10.js"></script><script src="event_handling_status.js"></script><script src="today_accident.js"></script><script src="cabinet_alert.js"></script><style>body{overflow:hidden;margin:0;padding:0;font-size:x-small;background:#191919}</style></head><body><script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script><script type="importmap">{
    "imports": {
        "three": "../build/three.module.js"
    }
}</script><div id="main" style="position:relative;width:100%"><header class="topnav"><span class="top-title"><span class="top-title-blue">FET IDC</span><span class="top-title-gray">機房</span></span><select type="search" id="nav-location" class="form-select form-select-sm form-control-dark text-white bg-dark py-0 top-search" onchange="OnChangeLocation()"><option value="north">北側機房</option><option value="south">南側機房</option><option value="all" selected="selected">全部</option></select><marquee class="top-text mx-2"><span class="text-white px-2"><span class="hexagon"><i class="bi bi-bookshelf"></i></span>機櫃<span class="top-number top-number-ani" id="nav-cabinet">-</span></span><span class="text-white px-2"><span class="hexagon"><i class="bi bi-pc"></i></span>主機<span class="top-number top-number-ani" id="nav-host">-</span></span><span class="text-white px-2"><span class="hexagon"><i class="bi bi-hdd-network-fill"></i></span>網路設備<span class="top-number top-number-ani" id="nav-net-device">-</span></span><span class="text-white px-2"><span class="hexagon"><i class="bi bi-device-hdd-fill"></i></span>儲存<span class="top-number top-number-ani" id="nav-storage">-</span></span><span class="text-white px-2"><span class="hexagon"><i class="bi bi-people-fill"></i></span>服務<span class="top-number top-number-ani" id="nav-network">-</span></span></marquee><div class="text-white top-alert mx-1"><span>告警狀態<span class="nav-alert-red">●</span><span id="alarm-status-critical" class="top-number-ani">2</span><span class="nav-alert-orange">●</span><span id="alarm-status-warning" class="top-number-ani">1</span>●<span id="alarm-status-normal" class="top-number-ani">2</span></span></div><div class="semicircle-outer mx-1"><canvas id="chartRackSpace" class="semicircle-inner"></canvas><div class="text-white semicircle-text-up top-number top-number-ani" id="nav-rack-space">2220</div><div class="text-white semicircle-text-down">機櫃空間</div></div><div class="semicircle-outer mx-1"><canvas id="chartPower" class="semicircle-inner"></canvas><div class="text-white semicircle-text-up top-number top-number-ani" id="nav-rack-power">1520</div><div class="text-white semicircle-text-down">電力</div></div><input id="searchInput" list="browsers" class="form-control form-control-sm form-control-dark text-white bg-dark py-0 top-search" placeholder="Search..."><datalist id="browsers"></datalist><button type="button" class="btn btn-outline-light btn-sm top-button" onclick="OnSearchClick()"><span class="bi bi-search"></span></button><button type="button" class="btn btn-outline-light btn-sm top-button" id="fullScreen"><span id="fullScreen-bi" class="bi bi-arrows-fullscreen"></span></button></header><div class="dashboard text-white dashboard-event-handling-status"><div><b><span class="square">▍</span>最近7日事件處理狀態</b></div><div class="event-handling-status"><canvas id="eventHandlingStatus"></canvas><br><br></div></div><div class="dashboard text-white dashboard-service-abnormal"><div><b><span class="square">▍</span>最近7日 TOP 10 服務異常統計</b></div><div class="service-abnormal mt-0"><canvas id="serviceAbnormal"></canvas><br><br></div></div><div class="dashboard text-white dashboard-today-accident"><div><b><span class="square">▍</span>今日事件處理狀態</b></div><table class="table table-sm today-accident"><tbody><tr><th>狀態</th><th>Count</th></tr><tr class="today-accident-bg1"><td class="today-accident-text">新事故</td><td class="today-accident-text"><span id="today-accident-new">-</span></td></tr><tr class="today-accident-bg2"><td class="today-accident-text">已恢復</td><td class="today-accident-text"><span id="today-accident-restored">-</span></td></tr><tr class="today-accident-bg1"><td class="today-accident-text">已結案</td><td class="today-accident-text"><span id="today-accident-closed">-</span></td></tr><tr class="today-accident-bg2"><td class="today-accident-text">已指派</td><td class="today-accident-text"><span id="today-accident-assigned">-</span></td></tr><tr class="today-accident-bg1"><td class="today-accident-text">指派逾期</td><td class="today-accident-text"><span id="today-accident-recovery-overdue">-</span></td></tr><tr class="today-accident-bg2"><td class="today-accident-text">指派逾期</td><td class="today-accident-text"><span id="today-accident-assignment-overdue">-</span></td></tr></tbody></table></div><div class="dashboard text-white dashboard-temperature"><div><b><span class="square">▍</span>溫度監控</b></div><div class="monitoring-container"><canvas id="temperature"></canvas><div class="text-white monitoring-text-percent" id="temperature-percent">-%</div><div class="text-white monitoring-text-count" id="temperature-count">-/-</div><div class="text-white monitoring-text-location">板橋IDC</div><div class="monitoring-text-left">板橋IDC<br>正常:<span id="temperature-normal">- (-%)</span></div></div></div><div class="dashboard text-white dashboard-power-monitoring"><div><b><span class="square">▍</span>電力監控</b></div><div class="monitoring-container"><canvas id="powerMonitoring"></canvas><div class="text-white monitoring-text-percent" id="power-percent">-%</div><div class="text-white monitoring-text-count" id="power-count">-/-</div><div class="text-white monitoring-text-location">板橋IDC</div><div class="monitoring-text-left">板橋IDC<br>正常:<span id="power-normal">- (-%)</span></div></div></div><div class="dashboard text-white dashboard-humidity-monitoring"><div><b><span class="square">▍</span>濕度監控</b></div><div class="monitoring-container"><canvas id="humidityMonitoring"></canvas><div class="text-white monitoring-text-percent" id="humidity-percent">-%</div><div class="text-white monitoring-text-count" id="humidity-count">-/-</div><div class="text-white monitoring-text-location">板橋IDC</div><div class="monitoring-text-left">板橋IDC<br>正常:<span id="humidity-normal">- (-%)</span></div></div></div><script type="module">import*as THREE from"three";import{MTLLoader}from"./jsm/loaders/MTLLoader.js";import{OBJLoader}from"./jsm/loaders/OBJLoader.js";import{OrbitControls}from"./jsm/controls/OrbitControls.js";import{EffectComposer}from"./jsm/postprocessing/EffectComposer.js";import{RenderPass}from"./jsm/postprocessing/RenderPass.js";import{OutlinePass}from"./jsm/postprocessing/OutlinePass.js";var container,camera,controls,scene,renderer,lighting,ambient,keyLight,fillLight,backLight;let clock,alertObj,composer,renderPass,alert_cabinet_list=[],mixer_arr=[],clipActiont=[];var selected_obj=[];let outlinePass,selectedObjects=[],mapTagInfo=new Map,mapIdInfo=new Map;var raycaster=new THREE.Raycaster,mouse=new THREE.Vector2;init(),animate();let loadMachines=function(){const e=.1,t=[],n=[],i=new XMLHttpRequest;i.onload=function(){const i=JSON.parse(this.responseText);for(let e=0;e<i.machines.length;e++){let t=mapIdInfo.get(i.machines[e].parent);const n={id:i.machines[e].id,cpx:t.cpx,cpy:t.cpy,cpz:t.cpz,tx:t.tx,ty:t.ty,tz:t.tz};mapTagInfo.set(i.machines[e].tag_info,n)}let o=[];for(let e=0;e<i.machines.length;e++){let t=i.machines[e].mesh_name;for(o[e]=!0;e+1<i.machines.length&&i.machines[e+1].mesh_name==t;)e++,o[e]=!1}for(let s=0;s<i.machines.length;s++){if(!o[s])continue;let a=i.machines[s].mesh_name;t[s]=new MTLLoader,t[s].setPath("assets/"+a+"/"),t[s].load(a+".mtl",(function(t){t.preload(),t.materials.default.map.magFilter=THREE.NearestFilter,t.materials.default.map.minFilter=THREE.LinearFilter,n[s]=new OBJLoader,n[s].setMaterials(t),n[s].setPath("assets/"+a+"/"),n[s].load(a+".obj",(function(t){let n=scene.getObjectByName(i.machines[s].parent);t.name=i.machines[s].id,t.show_type="level_03",t.tag_info=i.machines[s].tag_info,t.position.set(n.position.x,n.position.y+e*i.machines[s].locationU,n.position.z),t.scale.set(1,1,1);const o=new THREE.Quaternion;for(o.w=n.quaternion.w,o.x=n.quaternion.x,o.y=n.quaternion.y,o.z=n.quaternion.z,t.quaternion.copy(o),t.link_x=n.position.x,t.link_y=n.position.y+e*i.machines[s].locationU,t.link_z=n.position.z,scene.add(t);s+1<i.machines.length&&i.machines[s+1].mesh_name==a;){s++;let n=scene.getObjectByName(i.machines[s].parent),o=t.clone();o.name=i.machines[s].id,o.show_type="level_03",o.tag_info=i.machines[s].tag_info,o.position.set(n.position.x,n.position.y+e*i.machines[s].locationU,n.position.z),o.scale.set(1,1,1);const a=new THREE.Quaternion;a.w=n.quaternion.w,a.x=n.quaternion.x,a.y=n.quaternion.y,a.z=n.quaternion.z,o.quaternion.copy(a),o.link_x=n.position.x,o.link_y=n.position.y+e*i.machines[s].locationU,o.link_z=n.position.z;const r=(new THREE.MeshPhongMaterial).copy(t.children[0].material);o.children[0].material=r,scene.add(o)}}))}))}},i.open("GET","machines_tmp.json",!0),i.send()};function init(){container=document.createElement("div"),document.body.appendChild(container),(camera=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,.4,500)).position.x=5,camera.position.y=18,camera.position.z=18,scene=new THREE.Scene,lighting=!0,ambient=new THREE.AmbientLight(3355443,1);const e=new THREE.HemisphereLight(16777215,8947848,1.2);e.position.set(3,2,5),scene.add(ambient),scene.add(e);const t=[],n=[],i=new XMLHttpRequest;i.onload=function(){const e=JSON.parse(this.responseText);let i=[],o=[];for(let t=0;t<e.items.length;t++){let n=e.items[t].mesh_name;for(i[t]=!0;t+1<e.items.length&&e.items[t+1].mesh_name==n;)t++,i[t]=!1}for(let s=0;s<e.items.length;s++){if(!i[s])continue;let a=e.items[s].mesh_name;o.push(new Promise(((i,o)=>{t[s]=new MTLLoader,t[s].setPath("assets/"+a+"/"),t[s].load(a+".mtl",(function(t){t.preload(),t.materials.default.map.magFilter=THREE.NearestFilter,t.materials.default.map.minFilter=THREE.LinearFilter,n[s]=new OBJLoader,n[s].setMaterials(t),n[s].setPath("assets/"+a+"/"),n[s].load(a+".obj",(function(t){t.name=e.items[s].id,t.show_type=e.items[s].type,t.tag_info=e.items[s].tag_info,t.position.set(-e.items[s].x,e.items[s].y,e.items[s].z),t.scale.set(e.items[s].sx,e.items[s].sy,e.items[s].sz);const n=new THREE.Quaternion;n.w=-e.items[s].rqw,n.x=-e.items[s].rqx,n.y=e.items[s].rqy,n.z=e.items[s].rqz,t.quaternion.copy(n),t.link_x=-e.items[s].link_x,t.link_y=e.items[s].link_y,t.link_z=e.items[s].link_z;const o={id:e.items[s].id,cpx:-e.items[s].camera_x,cpy:e.items[s].camera_y,cpz:e.items[s].camera_z,tx:-e.items[s].target_x,ty:e.items[s].target_y,tz:e.items[s].target_z};for(mapTagInfo.set(e.items[s].tag_info,o),mapIdInfo.set(e.items[s].id,o),scene.add(t);s+1<e.items.length&&e.items[s+1].mesh_name==a;){s++;let n=t.clone();n.name=e.items[s].id,n.show_type=e.items[s].type,n.tag_info=e.items[s].tag_info,n.position.set(-e.items[s].x,e.items[s].y,e.items[s].z),n.scale.set(e.items[s].sx,e.items[s].sy,e.items[s].sz);const i=new THREE.Quaternion;i.w=-e.items[s].rqw,i.x=-e.items[s].rqx,i.y=e.items[s].rqy,i.z=e.items[s].rqz,n.quaternion.copy(i),n.link_x=-e.items[s].link_x,n.link_y=e.items[s].link_y,n.link_z=e.items[s].link_z;const o=(new THREE.MeshPhongMaterial).copy(t.children[0].material);n.children[0].material=o;const a={id:e.items[s].id,cpx:-e.items[s].camera_x,cpy:e.items[s].camera_y,cpz:e.items[s].camera_z,tx:-e.items[s].target_x,ty:e.items[s].target_y,tz:e.items[s].target_z};mapTagInfo.set(e.items[s].tag_info,a),mapIdInfo.set(e.items[s].id,a),scene.add(n)}i(`complete ${s}`)}))}))})))}Promise.all(o).then((e=>{loadMachines()}))},i.open("GET","build_setting.json",!0),i.send(),(renderer=new THREE.WebGLRenderer).setPixelRatio(window.devicePixelRatio),renderer.setSize(window.innerWidth,window.innerHeight),renderer.setClearColor(new THREE.Color("hsl(0, 0%, 10%)")),container.appendChild(renderer.domElement),(controls=new OrbitControls(camera,renderer.domElement)).dampingFactor=.25,controls.rotateSpeed=.15,controls.enableDamping=!0,controls.enableZoom=!0,controls.enableRotate=!0,controls.enablePan=!0,clock=new THREE.Clock,window.addEventListener("resize",onWindowResize,!1),window.addEventListener("keydown",onKeyboardEvent,!1),window.addEventListener("click",onMouseClick,!1),window.addEventListener("pointermove",onMouseMove,!1),window.addEventListener("message",onCabinetAlert,!1),composer=new EffectComposer(renderer),renderPass=new RenderPass(scene,camera),outlinePass=new OutlinePass(new THREE.Vector2(window.innerWidth,window.innerHeight),scene,camera),outlinePass.renderToScreen=!0,outlinePass.selectedObjects=selectedObjects,composer.addPass(renderPass),composer.addPass(outlinePass);var o=5,s=0;outlinePass.edgeStrength=o,outlinePass.edgeGlow=s,outlinePass.visibleEdgeColor.set(16777215),outlinePass.hiddenEdgeColor.set(16777215)}function onCabinetAlert(e){for(let e=0;e<alert_cabinet_list.length;e++)alertObj=scene.getObjectByName(alert_cabinet_list[e]),alertObj.children[0].material.emissive.setHex(0),alertObj.state="normal";alert_cabinet_list=e.data;for(let e=0;e<alert_cabinet_list.length;e++)if(alertObj=scene.getObjectByName(alert_cabinet_list[e]),null!=alertObj){const t=new THREE.ColorKeyframeTrack(".material.emissive",[0,.5,1],[1,0,0,1,.65,0,1,0,0]),n=new THREE.AnimationClip("Action",1,[t]);mixer_arr[e]=new THREE.AnimationMixer(alertObj.children[0]),clipActiont[e]=mixer_arr[e].clipAction(n),clipActiont[e].play(),alertObj.state="warning"}else alert_cabinet_list.splice(e,1),e--}let enable_raycasting=!0;var currInter;function onMouseMove(e){if(enable_raycasting){const n=renderer.domElement.getBoundingClientRect();mouse.x=(e.clientX-n.left)/(n.right-n.left)*2-1,mouse.y=-(e.clientY-n.top)/(n.bottom-n.top)*2+1,raycaster.setFromCamera(mouse,camera);var t=raycaster.intersectObjects(scene.children,!0);t.length>0&&"base"!=t[0].object.parent.show_type?currInter!=t[0].object&&(currInter&&OnObjHoverOut(currInter),currInter=t[0].object,OnObjHoverIn(currInter)):(currInter&&OnObjHoverOut(currInter),currInter=null)}}function onMouseClick(e){if(enable_raycasting){const n=renderer.domElement.getBoundingClientRect();mouse.x=(e.clientX-n.left)/(n.right-n.left)*2-1,mouse.y=-(e.clientY-n.top)/(n.bottom-n.top)*2+1,raycaster.setFromCamera(mouse,camera);var t=raycaster.intersectObjects(scene.children,!0);t.length>0&&("level_03"==t[0].object.parent.show_type?window.open("viewer2d.html","","width=1200,height=700,location=no,menubar=no,status=no,titlebar=no,top=50,left=100"):"base"!=t[0].object.parent.show_type&&AddInfoPanel(t[0].object))}}function AddInfoPanel(e){console.log("obj3d ="),console.log(e);let t=e.parent.name;if(selected_obj.includes(t))return;selected_obj.push(t);let n,i=60+140*selected_obj.findIndex((e=>e==t));"warning"!=e.parent.state&&(selectedObjects.push(e),outlinePass.selectedObjects=selectedObjects),n="warning"==e.parent.state?`\n            <div id="${t}" class="infopanel-warning" style="top:${i}px;right:290px;">\n            <div style="z-index:20;">\n                <button type="button" class="btn btn-sm btn-dark info-close-btn" onclick="RemoveInfoPanel('${t}');">✕</button>\n                <div class="text-white info-status"><span>設備溫度過高</span></div>\n                <div class="infopanel-flex-container" id="warning-panel-${t}"></div>\n                <button type="button" class="btn btn-sm btn-primary info-more-btn">更多資訊</button>\n            </div></div>`:`\n            <div id="${t}" class="infopanel-normal" style="top:${i}px;right:290px;">\n            <div style="z-index:20;">\n                <button type="button" class="btn btn-sm btn-dark info-close-btn" onclick="RemoveInfoPanel('${t}');">✕</button>\n                <div class="text-white info-status"><span>設備正常</span></div>\n                <div class="infopanel-flex-container" id="warning-panel-${t}"></div>\n                <button type="button" class="btn btn-sm btn-primary info-more-btn">更多資訊</button>\n            </div></div>`,$("#main").append(n),$(".infopanel").on("mouseenter",(()=>enable_raycasting=!1)),$(".infopanel").on("mouseleave",(()=>enable_raycasting=!0)),SetCabinetInfo(t);let o,s=CalcInfoLinePos(e.parent,t,renderer,THREE,camera),a=t+"_line1",r=t+"_line2",l=t+"_line1line",c=t+"_line2line";o="warning"==e.parent.state?"rgb(133,0,24)":"rgb(66,138,181)";let m=`\n                <svg id="${a}" style="position:absolute;top:${s.offset1.y}px;right:${s.offset1.x}px;z-index:1;height:${s.h1}px;width:${s.w1}px;background-color:${o};">\n                <line id="${l}" x1="0" y1="0" style="stroke:${o};stroke-width:3;x2:${s.x1};y2:${s.y1};" />\n                Sorry, your browser does not support inline SVG.\n                </svg>`,d=`\n                <svg id="${r}" style="position:absolute;top:${s.offset2.y}px;right:${s.offset2.x}px;z-index:1;height:${s.h2}px;width:${s.w2}px;background-color:${o};">\n                <line id="${c}" x1="0" y1="0" style="stroke:${o};stroke-width:3;x2:${s.x2};y2:${s.y2};" />\n                Sorry, your browser does not support inline SVG.\n                </svg>`;$(`#${t}`).append(m),$(`#${t}`).append(d),selected_obj.length>5&&RemoveInfoPanel(selected_obj[0])}function onWindowResize(){camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight)}function onKeyboardEvent(e){"KeyL"===e.code&&((lighting=!lighting)?(ambient.intensity=.25,scene.add(keyLight),scene.add(fillLight),scene.add(backLight)):(ambient.intensity=1,scene.remove(keyLight),scene.remove(fillLight),scene.remove(backLight)))}function render(){const e=clock.getDelta();if(mixer_arr[0]){for(let t=0;t<alert_cabinet_list.length;t++)mixer_arr[t].update(e);mixer_arr[0].update(e),mixer_arr[1].update(e)}composer.render(scene,camera),updateLineVisibility()}function animate(){requestAnimationFrame(animate),controls.update(),render()}function updateLineVisibility(){for(let e=0;e<selected_obj.length;e++){let t=selected_obj[e]+"_line1",n=selected_obj[e]+"_line2",i=selected_obj[e]+"_line1line",o=selected_obj[e]+"_line2line",s=scene.getObjectByName(selected_obj[e]),a=CalcInfoLinePos(s,selected_obj[e],renderer,THREE,camera);document.getElementById(t).style.height=a.h1+"px",document.getElementById(t).style.width=a.w1+"px",document.getElementById(t).style.top=a.offset1.y+"px",document.getElementById(t).style.right=a.offset1.x+"px",document.getElementById(i).style.x2=a.x1,document.getElementById(i).style.y2=a.y1,document.getElementById(n).style.height=a.h2+"px",document.getElementById(n).style.width=a.w2+"px",document.getElementById(n).style.top=a.offset2.y+"px",document.getElementById(n).style.right=a.offset2.x+"px",document.getElementById(o).style.x2=a.x2,document.getElementById(o).style.y2=a.y2}}$(".dashboard").on("mouseenter",(()=>enable_raycasting=!1)),$(".dashboard").on("mouseleave",(()=>enable_raycasting=!0)),$(".topnav").on("mouseenter",(()=>enable_raycasting=!1)),$(".topnav").on("mouseleave",(()=>enable_raycasting=!0)),$(".infopanel").on("mouseenter",(()=>enable_raycasting=!1)),$(".infopanel").on("mouseleave",(()=>enable_raycasting=!0)),window.OnSearchClick=function(){const e=mapTagInfo.get($("#searchInput").val());null!=e&&(camera.position.x=e.cpx,camera.position.y=e.cpy,camera.position.z=e.cpz,controls.target.set(e.tx,e.ty,e.tz))},window.RemoveInfoPanel=function(e){let t=selected_obj.findIndex((t=>t==e));selected_obj.splice(t,1),selectedObjects.splice(t,1),outlinePass.selectedObjects=selectedObjects,$(`#${e}`).remove();for(let e=0;e<selected_obj.length;e++){let t=60+140*e;document.getElementById(selected_obj[e]).style.top=t+"px"}enable_raycasting=!0}</script></div></body></html>