<!DOCTYPE html>
<html>
<head>

<title>Viewer</title>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
<script src="three.js"></script>
<script src="Detector.js"></script>
<script src="OrbitControls.js"></script>
<script src="OBJLoader.js"></script>
<script src="MTLLoader.js"></script>

<style>
    body {
        overflow: hidden;
        margin: 0;
        padding: 0;
		font-size: x-small;
        background: hsl(0, 0%, 10%);
    }
	
	.sidebar {
		height: 100%;
		width: 250px;
		position: fixed;
		z-index: 1;
		top: 0;
		left: -250px;
		background-color: rgba(255, 255, 255, 1.0);
		overflow-x: hidden;
		transition: 0.5s;
		padding: 10px;
	}

	.sidebar a {
		padding: 8px 8px 8px 32px;
		text-decoration: none;
		font-size: 25px;
		color: #818181;
		display: block;
		transition: 0.3s;
	}

	.sidebar .closebtn {
		position: absolute;
		top: 0;
		right: 25px;
		font-size: 36px;
		margin-left: 50px;
	}

	.openbtn {
		font-size: 20px;
		cursor: pointer;
		background-color: #444;
		color: white;
		border-radius: 20px;
		width: 40px;
		height: 40px;
		border: none;
	}

	.openbtn:hover {
		background-color: #111;
		
	}
	
	#togglebtn {
		background-color: rgba(255, 255, 255, 0.0);
		position: absolute;
		padding: 5px;
		transition: all, 0.5s;
		z-index: 2;
	}
	
	.infopanel {
		position: absolute;
		padding:0px;
	}
	
	.info-close-btn {
		width: 26px;
		height: 26px;
		position: absolute;
		top: 3px;
		right: 5px;
		padding: 0px;
		border-radius: 5px;
	}

</style>

</head>
<body>

<div id="main" style="position: relative; width: 100%;">

	<div id="togglebtn">
		<button id="togbtn" class="openbtn" onclick="toggleNav()">→</button>	
	</div>	
	
	<div id="mySidebar" class="sidebar">
		<div><b>Server 總數</b></div>
		<canvas id="myBarChart" width="230" height="230"></canvas><br><br>
		<div><b>Storage 總數</b></div>
		<canvas id="myDoughnut" width="230" height="230"></canvas><br><br>
		<button type="button" class="btn btn-outline-primary" onclick="onRndAlertClick();">Send Random Alert</button>
	</div>

	
	<script>
	/******************
		Chart.js
	******************/
	const ctx_bar = document.getElementById('myBarChart').getContext('2d');
	const myBarChart = new Chart(ctx_bar, {
		type: 'bar',
		data: {
			labels: ['Dell R740', 'HP ProLiant DL380 G7', 'HP ProLiant DL380p Gen8', 'LENOVO System x3650 M5'],
			datasets: [{
				label: '# of Servers',
				data: [12, 19, 3, 5],
				backgroundColor: [
					'rgba(255, 99, 132, 0.2)',
					'rgba(54, 162, 235, 0.2)',
					'rgba(255, 206, 86, 0.2)',
					'rgba(75, 192, 192, 0.2)'
				],
				borderColor: [
					'rgba(255, 99, 132, 1)',
					'rgba(54, 162, 235, 1)',
					'rgba(255, 206, 86, 1)',
					'rgba(75, 192, 192, 1)'
				],
				borderWidth: 1
			}]
		},
		options: {
			scales: {
				y: {
					beginAtZero: true
				}
			}
		}
	});
	
	const ctx_doughnut = document.getElementById('myDoughnut').getContext('2d');
	const myDoughnut = new Chart(ctx_doughnut, {
		type: 'doughnut',
		data: {
			labels: ['AMS2500', 'G620', 'HUS130', 'HDS F370'],
			datasets: [{
				label: '# of Votes',
				data: [12, 19, 3, 5],
				backgroundColor: [
					'rgba(255, 99, 132, 0.2)',
					'rgba(54, 162, 235, 0.2)',
					'rgba(255, 206, 86, 0.2)',
					'rgba(75, 192, 192, 0.2)'
				],
				borderColor: [
					'rgba(255, 99, 132, 1)',
					'rgba(54, 162, 235, 1)',
					'rgba(255, 206, 86, 1)',
					'rgba(75, 192, 192, 1)'
				],
				borderWidth: 1
			}]
		},
		options: {
			scales: {
				y: {
					beginAtZero: true
				}
			}
		}
	});
	
	</script>
	
	
	

	<script>
	/******************
		Toggle
	******************/	
	function toggleNav()
	{
		if(document.getElementById("mySidebar").style.left == "0px")
			closeNav();
		else
			openNav();
	}
	
	function openNav()
	{
		document.getElementById("mySidebar").style.left = "0px";
		document.getElementById("togglebtn").style.paddingLeft = "230px";
		document.getElementById("togbtn").innerHTML = "←";	
	}

	function closeNav()
	{
		document.getElementById("mySidebar").style.left = "-250px";
		document.getElementById("togglebtn").style.paddingLeft= "5px";
		document.getElementById("togbtn").innerHTML = "→";
	}
	</script>
	
	
	
    <script>
	/******************
		Three.js
	******************/

    if (!Detector.webgl) {
        Detector.addGetWebGLMessage();
    }

    var container;

    var camera, controls, scene, renderer;
    var lighting, ambient, keyLight, fillLight, backLight;

	let mixer;
	let clock;
	let alertObj;
	let clipAction;
	
	init();
    animate();
	

	var objIds = [];

    function init() {

        container = document.createElement('div');
        document.body.appendChild(container);

        /* Camera */

        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 1000);
        camera.position.x = -3;
		camera.position.y = 5;
		camera.position.z = 5;

        /* Scene */

        scene = new THREE.Scene();
        lighting = true;

		
		/* Lighting*/
		
        ambient = new THREE.AmbientLight(0x333333, 1.0);
        
		const light = new THREE.HemisphereLight( 0xffffff, 0x888888 );
		light.position.set( 2.0, 1, 0 );
		
		scene.add( ambient );
		scene.add( light );
		
		

        /* Model */
		const mtlLoader = [];
		const objLoader = [];
		const xmlhttp = new XMLHttpRequest();
		xmlhttp.onload = function()
		{
			const myArr = JSON.parse(this.responseText);
		  	    
			for (let i = 0; i < myArr.items.length; i++)
			{
				let mesh_name = myArr.items[i].mesh_name;
				
				objIds[i] = myArr.items[i].machine_id;
				
				mtlLoader[i] = new THREE.MTLLoader();
				mtlLoader[i].setBaseUrl('assets/'+ mesh_name +'/');
				mtlLoader[i].setPath('assets/'+ mesh_name +'/');
				mtlLoader[i].load( mesh_name + '.mtl', function (materials)
				{
					materials.preload();

					materials.materials.default.map.magFilter = THREE.NearestFilter;
					materials.materials.default.map.minFilter = THREE.LinearFilter;

					objLoader[i] = new THREE.OBJLoader();
					objLoader[i].setMaterials(materials);
					objLoader[i].setPath('assets/'+ mesh_name +'/');
					objLoader[i].load( mesh_name + '.obj', function (object)
					{	

						// *****************
						// add 3d object
						// *****************
						object.name        = myArr.items[i].machine_id;
						object.machine_id  = myArr.items[i].machine_id;
						object.show_type   = myArr.items[i].type;
						object.is_selected = false;
						
						object.translateX(-myArr.items[i].x);
						object.translateY(myArr.items[i].y-1.5);
						object.translateZ(myArr.items[i].z);
							
						scene.add(object);
					});
				});				
			}
		}
		xmlhttp.open("GET", "build_setting.json", true);
		xmlhttp.send();



		



        /* Renderer */
        renderer = new THREE.WebGLRenderer();
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setClearColor(new THREE.Color("hsl(0, 0%, 10%)"));

        container.appendChild(renderer.domElement);


        /* Controls */
        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.25;
		controls.rotateSpeed = 0.15;
        controls.enableZoom = true;
		controls.enableRotate = true;


		clock = new THREE.Clock();


        /* Events */
        window.addEventListener( 'resize', onWindowResize, false);
        window.addEventListener( 'keydown', onKeyboardEvent, false);
		
		window.addEventListener( 'click', onMouseClick, false );
		window.addEventListener( 'pointermove', onMouseMove, false );
    }



	/* OnMouseMove */
	
	var currInter;
	function onMouseMove( event )
	{

		const rect = renderer.domElement.getBoundingClientRect();
		mouse.x = ( ( event.clientX - rect.left ) / ( rect.right - rect.left ) ) * 2 - 1;
		mouse.y = - ( ( event.clientY - rect.top ) / ( rect.bottom - rect.top) ) * 2 + 1;
		
		raycaster.setFromCamera( mouse, camera );

		// 獲取raycaster直線和所有模型相交的陣列集合
		var intersects = raycaster.intersectObjects( scene.children, true );


		if ( intersects.length > 0 && 
			 intersects[0].object.parent.show_type != "base" &&
			!intersects[0].object.parent.is_selected ) {

			if ( currInter != intersects[0].object ) {

				if ( currInter )
					currInter.material.emissive.setHex( currInter.currentHex );

				currInter = intersects[0].object;
				currInter.currentHex = currInter.material.emissive.getHex();
				currInter.material.emissive.setHex( 0x333333 );
			}
		}
		else {
		
			if ( currInter && !currInter.parent.is_selected ) {
				currInter.material.emissive.setHex( currInter.currentHex );
			}
			
			currInter = null;
		}
	}



	/* OnMouseClick */
	
	var raycaster = new THREE.Raycaster();
	var mouse = new THREE.Vector2();

	var is_outside = false;
	var is_inside = [false, false, false];
	
	var selected_outside = "";
	var selected_inside  = ["", "", ""];
	
	
	function RemoveOutside()
	{
		$('#outside-machine').remove();
		is_outside = false;
		
		selected_outside.material.emissive.setHex( 0x000000 );
		selected_outside.parent.is_selected = false;
	}
	
	
	function RemoveInside( sid )
	{	
		$('#inside-0'+sid).remove();	
		is_inside[sid] = false;
		
		selected_inside[sid].material.emissive.setHex( 0x000000 );
		selected_inside[sid].parent.is_selected = false;
	}	

	
	function onMouseClick( event )
	{
		//通過滑鼠點選的位置計算出raycaster所需要的點的位置，以螢幕中心為原點，值的範圍為-1到1
		const rect = renderer.domElement.getBoundingClientRect();
		mouse.x = ( ( event.clientX - rect.left ) / ( rect.right - rect.left ) ) * 2 - 1;
		mouse.y = - ( ( event.clientY - rect.top ) / ( rect.bottom - rect.top) ) * 2 + 1;

		// 通過滑鼠點的位置和當前相機的矩陣計算出raycaster
		raycaster.setFromCamera( mouse, camera );

		// 獲取raycaster直線和所有模型相交的陣列集合
		var intersects = raycaster.intersectObjects( scene.children, true );

		console.log(intersects);

		if( intersects.length > 0 )
		{
			if(intersects[0].object.parent.show_type == "outside")
			{	
				let posY = event.clientY+50;
				
				if(is_outside) {
					RemoveOutside();
				}
				
				AddOutside( intersects[0].object, posY );
			}
			else if(intersects[0].object.parent.show_type == "inside")
			{
				var is_repeat = false;
				if( document.getElementById("inside-00-id") != null &&
				   (document.getElementById("inside-00-id").innerHTML == intersects[0].object.parent.machine_id) )
					is_repeat = true;
				
				if( document.getElementById("inside-01-id") != null &&
				   (document.getElementById("inside-01-id").innerHTML == intersects[0].object.parent.machine_id) )
					is_repeat = true;
					
				if( document.getElementById("inside-02-id") != null &&
				   (document.getElementById("inside-02-id").innerHTML == intersects[0].object.parent.machine_id) )
					is_repeat = true;

				if(!is_repeat)
				{	
					AddInside( intersects[0].object );
				}
			}
		}
	}
	
	function onRndAlertClick()
	{
		console.log(alertObj);
		
		if( alertObj != undefined )
		{
			clipAction.stop();
			alertObj.children[0].material.emissive.setHex( 0x000000 );
		}
	
		var audio = new Audio("yisell_sound.mp3");
		audio.play();
	
		// 挑選合法物件
		//var alertObj;
		var illegal = true;
		while( illegal ) 
		{
			var rnd = Math.floor( Math.random()*objIds.length );
			alertObj = scene.getObjectByName(objIds[rnd]);
			
			if( !alertObj.is_selected )
				illegal = false;
			
			if( alertObj.show_type == "base" )
				illegal = true;
		}
		console.log(alertObj);

		// Animation
		const emissiveKF = new THREE.ColorKeyframeTrack( '.material.emissive', [ 0, 0.5, 1 ], [ 1, 0, 0, 1, 0.65, 0, 1, 0, 0 ] );
		const clip = new THREE.AnimationClip( 'Action', 1, [emissiveKF] );
		mixer = new THREE.AnimationMixer( alertObj.children[0] );
		clipAction = mixer.clipAction( clip );
		clipAction.play();
    }
	
	function render()
	{
		const delta = clock.getDelta();
		if ( mixer ) {
			mixer.update( delta );
		}

        renderer.render(scene, camera);
    }		
	

	function AddOutside( obj3d, posY )
	{
		selected_outside = obj3d;
		obj3d.material.emissive.setHex( 0x000000 );
		obj3d.currentHex = obj3d.material.emissive.getHex();
		obj3d.material.emissive.setHex( 0x005555 );
		obj3d.parent.is_selected = true;
		
		
		let info = `
		<div id="outside-machine" class="card infopanel" style="top:${posY}px;left:280px;">
			<button type="button" class="btn btn-dark info-close-btn" onclick="RemoveOutside();is_outside = false;">✕</button>
			<div class="card-header">${obj3d.parent.machine_id}</div>
			<div class="card-body">
			  <table class="table table-bordered table-sm">
				<tbody>
				  <tr><td>IDC-ESALESCL01P</td></tr>
				  <tr><td>IDC-ESALESCL02P</td></tr>
				  <tr><td>IDC-ESALESCL03P</td></tr>
				  <tr><td>IDC-ESALESCL04P</td></tr>
				  <tr><td>IDC-ESALESCL05P</td></tr>
				  <tr><td style="background-color:LightGray;"></td></tr>
				  <tr><td>IDC-ESALESCL06P</td></tr>
				  <tr><td>IDC-ESALESCL07P</td></tr>
				  <tr><td>IDC-ESALESCL08P</td></tr>
				  <tr><td>IDC-ESALESCL09P</td></tr>
				  <tr><td>IDC-ESALESCL10P</td></tr>			  
				</tbody>
			  </table>
			</div>
		</div>`;
		
		$("#main").append(info);
		
		is_outside = true;			
	}



	function AddInside( obj3d )
	{
		/* 決定 select id: sid */
		let sid = 0;
		let inside_id = "inside-01";
		let inside_id_remove = "is_inside[0] = false;";
		let posY = 5;
		if(!is_inside[0]) {
			sid = 0;
		}
		else if(!is_inside[1]) {
			sid = 1;
		}
		else if(!is_inside[2]) {
			sid = 2;
		}
		else
		{
			sid = Math.floor(Math.random()*(3)); //0~2取亂數
			RemoveInside(sid);
		}

		posY = (sid*180) + 10;
		is_inside[sid] = true;
		inside_id = "inside-0" + sid;
		inside_id_remove = "is_inside["+ sid +"] = false;";


		//
		selected_inside[sid] = obj3d;
		obj3d.material.emissive.setHex( 0x000000 );
		obj3d.currentHex = obj3d.material.emissive.getHex();
		obj3d.material.emissive.setHex( 0x005555 );
		obj3d.parent.is_selected = true;


		var rnd = Math.floor(Math.random()*(3)); //0~2取亂數
		
		var color = "Tomato";
		var str = "CRITICAL";
		if( rnd == 0 ) {
			color = "Orange";
			str = "WARNING";			
		}
		else if ( rnd == 1 ) {
			color = "MediumSeaGreen";
			str = "UP";
		}
		else {
			color = "Tomato";
			str = "CRITICAL";
		}
		
		let info = `
		<div id="${inside_id}" class="card infopanel" style="top:${posY}px;right:5px;">
			<button type="button" class="btn btn-dark info-close-btn" onclick="RemoveInside(${sid});">✕</button>
			<div id="${inside_id}-id" class="card-header">${obj3d.parent.machine_id}</div>
			<div class="card-body">
			  <table class="table table-bordered table-sm">
				<tbody>
				  <tr>
					<td style="color:DodgerBlue;">Map Name</td>
					<td>3201_NSP22_Arch (3201_NSP22_Arch)</td>
				  </tr>
				  <tr>
					<td style="color:DodgerBlue;">Summary State</td>
					<td style="color:White; background-color:${color};">${str}</td>
				  </tr>
				  <tr>
					<td style="color:DodgerBlue;">Summary Output</td>
					<td>Contains 1 CRITICAL, 149 UP, 21 OK Objects</td>
				  </tr>
				</tbody></table></div></div>`;
		
		
		$("#main").append(info);
	
	}





    function onWindowResize()
	{

        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();

        renderer.setSize(window.innerWidth, window.innerHeight);
    }


    function onKeyboardEvent(e) {

        if (e.code === 'KeyL') {

            lighting = !lighting;

            if (lighting) {

                ambient.intensity = 0.25;
                scene.add(keyLight);
                scene.add(fillLight);
                scene.add(backLight);

            } else {

                ambient.intensity = 1.0;
                scene.remove(keyLight);
                scene.remove(fillLight);
                scene.remove(backLight);

            }
        }
    }
    function animate() {

        requestAnimationFrame(animate);
        controls.update();
        render();

    }

    </script>	
	
	
</div>








</body>
</html>
